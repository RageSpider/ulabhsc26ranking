<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS | Prime Admin Override</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- THEME CONFIG -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#030304',
                        surface: '#0E0E10',
                        panel: '#161618',
                        border: '#27272A',
                        primary: '#6366F1', // Indigo
                        accent: '#8B5CF6',  // Violet
                        success: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        text: '#E4E4E7',
                        muted: '#71717A'
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #030304; color: #E4E4E7; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(22, 22, 24, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .grid-bg { background-image: radial-gradient(rgba(99, 102, 241, 0.1) 1px, transparent 1px); background-size: 20px 20px; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .loading-line { height: 2px; width: 100%; background: #27272A; overflow: hidden; position: absolute; top: 0; left: 0; }
        .loading-line::after {
            content: ''; display: block; height: 100%; width: 50%; background: #6366F1;
            position: absolute; animation: load 1s infinite ease-in-out;
        }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

        .animate-fade-up { animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm selection:bg-primary selection:text-white">

    <!-- LOGIN OVERLAY -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center">
        <div class="w-full max-w-md bg-surface border border-border rounded-xl shadow-2xl overflow-hidden p-8 animate-fade-up">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-primary/20">NX</div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight">NEXUS PRIME</h1>
                    <p class="text-xs text-muted font-mono">Restricted Access // Owner Only</p>
                </div>
            </div>
            
            <div id="login-form">
                <p class="text-sm text-gray-400 mb-4">Authenticate to decrypt voting data.</p>
                <div class="space-y-3">
                    <input type="email" id="email" placeholder="admin@nexus.com" class="w-full bg-black/50 border border-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all placeholder:text-gray-600">
                    <input type="password" id="password" placeholder="••••••••••••" class="w-full bg-black/50 border border-border rounded-lg px-4 py-3 text-white focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition-all placeholder:text-gray-600">
                    <button onclick="handleLogin()" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="lock-open" class="w-4 h-4"></i> Authenticate
                    </button>
                </div>
                <div class="mt-4 text-center">
                    <p id="login-msg" class="text-xs text-red-400 min-h-[1.5em]"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="flex h-full relative">
        <!-- TOP LOADING BAR -->
        <div id="global-loader" class="loading-line z-50 hidden"></div>

        <!-- SIDEBAR -->
        <aside class="w-64 bg-surface border-r border-border flex flex-col shrink-0 z-20">
            <div class="h-16 flex items-center px-6 border-b border-border gap-3">
                <div class="w-6 h-6 bg-primary rounded flex items-center justify-center text-white text-xs font-bold">NX</div>
                <span class="font-bold tracking-tight text-gray-200">Admin Console</span>
            </div>

            <nav class="p-4 space-y-1 flex-1">
                <div class="text-[10px] uppercase font-bold text-muted tracking-wider mb-2 px-2">Monitoring</div>
                <button onclick="switchView('feed')" id="nav-feed" class="w-full text-left px-3 py-2 rounded-lg text-xs font-medium flex items-center gap-3 bg-white/5 text-white border border-white/5">
                    <i data-lucide="activity" class="w-4 h-4 text-primary"></i> 
                    <span>Live Feed</span>
                    <span id="badge-total" class="ml-auto text-[10px] bg-black/50 px-1.5 py-0.5 rounded text-gray-400">0</span>
                </button>
                <button onclick="switchView('voters')" id="nav-voters" class="w-full text-left px-3 py-2 rounded-lg text-xs font-medium text-muted hover:text-white hover:bg-white/5 flex items-center gap-3 transition-colors">
                    <i data-lucide="users" class="w-4 h-4 text-warning"></i> Voter Database
                </button>
                <button onclick="switchView('candidates')" id="nav-candidates" class="w-full text-left px-3 py-2 rounded-lg text-xs font-medium text-muted hover:text-white hover:bg-white/5 flex items-center gap-3 transition-colors">
                    <i data-lucide="layers" class="w-4 h-4 text-accent"></i> Entities
                </button>
            </nav>

            <div class="p-4 border-t border-border">
                <div class="flex items-center gap-3 p-2 rounded-lg bg-black/30 border border-border">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-primary to-accent flex items-center justify-center text-white font-bold text-xs" id="user-avatar-fallback">
                        AD
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold truncate text-white" id="current-user-email">--</div>
                        <div class="text-[10px] text-green-500 font-mono">● ONLINE</div>
                    </div>
                    <button onclick="handleLogout()" class="text-muted hover:text-white"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col bg-bg relative overflow-hidden">
            <!-- HEADER -->
            <header class="h-16 border-b border-border bg-surface/50 backdrop-blur flex items-center justify-between px-6 shrink-0 z-10">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-white flex items-center gap-2">Live Feed</h2>
                    <span id="refresh-indicator" class="text-[10px] text-muted font-mono bg-border px-2 py-1 rounded hidden">SYNCING...</span>
                </div>
                <div class="flex gap-3">
                    <div class="relative">
                        <i data-lucide="search" class="w-3.5 h-3.5 absolute left-3 top-2.5 text-muted"></i>
                        <input type="text" id="global-search" placeholder="Search emails, IDs, names..." 
                            class="w-64 bg-black/50 border border-border rounded-lg pl-9 pr-3 py-2 text-xs text-white focus:border-primary focus:outline-none transition-all">
                    </div>
                    <button onclick="refreshData()" class="p-2 text-muted hover:text-white bg-surface border border-border rounded-lg transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button onclick="exportCSV()" class="flex items-center gap-2 px-3 py-2 bg-white text-black font-bold text-xs rounded-lg hover:bg-gray-200 transition-colors">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i> Export
                    </button>
                </div>
            </header>

            <!-- VIEWPORT -->
            <div class="flex-1 overflow-y-auto p-6 scroll-smooth" id="content-area">
                
                <!-- DASHBOARD / FEED VIEW -->
                <div id="view-feed" class="view-section space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="glass-panel p-4 rounded-xl">
                            <div class="text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Total Votes</div>
                            <div class="text-2xl font-bold text-white font-mono" id="stat-votes">--</div>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <div class="text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Active Voters</div>
                            <div class="text-2xl font-bold text-white font-mono" id="stat-voters">--</div>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <div class="text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Avg Score</div>
                            <div class="text-2xl font-bold text-primary font-mono" id="stat-avg">--</div>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <div class="text-muted text-[10px] uppercase font-bold tracking-wider mb-1">Last Activity</div>
                            <div class="text-sm font-bold text-success font-mono mt-2" id="stat-last">--</div>
                        </div>
                    </div>

                    <!-- Main Table -->
                    <div class="glass-panel rounded-xl overflow-hidden flex flex-col">
                        <div class="px-4 py-3 border-b border-border flex justify-between items-center bg-white/5">
                            <h3 class="font-bold text-xs text-gray-300">Transaction Log</h3>
                            <div class="flex gap-2 text-[10px]">
                                <span class="flex items-center gap-1.5 px-2 py-1 rounded bg-red-500/10 text-red-400 border border-red-500/20"><div class="w-1.5 h-1.5 rounded-full bg-red-500"></div> Negative &lt; 20</span>
                                <span class="flex items-center gap-1.5 px-2 py-1 rounded bg-green-500/10 text-green-400 border border-green-500/20"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> Positive &gt; 90</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="text-[10px] text-muted uppercase font-bold bg-black/20">
                                    <tr>
                                        <th class="px-4 py-3">Time</th>
                                        <th class="px-4 py-3">User Identity</th>
                                        <th class="px-4 py-3">Target Entity</th>
                                        <th class="px-4 py-3 text-right">Score</th>
                                        <th class="px-4 py-3 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-border text-xs" id="feed-table-body">
                                    <!-- JS Content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VOTERS VIEW -->
                <div id="view-voters" class="view-section hidden h-full flex flex-col">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                        <!-- List -->
                        <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full border-r border-border">
                             <div class="p-3 border-b border-border bg-surface">
                                 <input type="text" id="voter-search" placeholder="Filter voters..." class="w-full bg-black border border-border rounded px-3 py-1.5 text-xs text-white focus:border-primary outline-none">
                             </div>
                             <div class="flex-1 overflow-y-auto p-2 space-y-1" id="voter-list-container">
                                <!-- JS Content -->
                             </div>
                        </div>

                        <!-- Detail Card -->
                        <div class="lg:col-span-2 glass-panel rounded-xl overflow-hidden flex flex-col h-full relative" id="voter-detail-panel">
                            <div class="absolute inset-0 flex items-center justify-center text-muted text-xs pointer-events-none" id="voter-placeholder">
                                Select a voter to inspect profile
                            </div>
                            
                            <div id="voter-content" class="hidden h-full flex flex-col">
                                <!-- Header -->
                                <div class="p-6 border-b border-border bg-gradient-to-r from-surface to-bg relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-32 bg-primary/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                                    <div class="flex items-start gap-5 relative z-10">
                                        <img id="vd-avatar" src="" class="w-16 h-16 rounded-full bg-black border-2 border-border object-cover">
                                        <div>
                                            <h2 class="text-xl font-bold text-white" id="vd-name">User Name</h2>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-xs text-muted font-mono" id="vd-email">email@example.com</span>
                                                <span class="text-[10px] bg-white/10 px-1.5 py-0.5 rounded text-gray-400" id="vd-id">ID</span>
                                            </div>
                                            <div class="flex gap-2 mt-3">
                                                <div class="text-[10px] uppercase font-bold tracking-wider text-muted">First Seen: <span class="text-gray-300" id="vd-joined">--</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stats Row -->
                                <div class="grid grid-cols-3 divide-x divide-border border-b border-border bg-black/20">
                                    <div class="p-4 text-center">
                                        <div class="text-2xl font-bold text-white" id="vd-count">0</div>
                                        <div class="text-[10px] text-muted uppercase">Votes Cast</div>
                                    </div>
                                    <div class="p-4 text-center">
                                        <div class="text-2xl font-bold text-primary" id="vd-avg">0</div>
                                        <div class="text-[10px] text-muted uppercase">Average Score</div>
                                    </div>
                                    <div class="p-4 text-center">
                                        <div class="text-2xl font-bold text-white" id="vd-rank">#--</div>
                                        <div class="text-[10px] text-muted uppercase">Rank</div>
                                    </div>
                                </div>

                                <!-- History -->
                                <div class="flex-1 overflow-y-auto p-4 bg-bg/50">
                                    <h4 class="text-[10px] uppercase font-bold text-muted mb-3">Voting History</h4>
                                    <div class="space-y-2" id="vd-history">
                                        <!-- Items -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CANDIDATES VIEW -->
                <div id="view-candidates" class="view-section hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="candidates-grid">
                        <!-- JS Content -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- LOGIC -->
    <script>
        // CONFIG
        const SUPABASE_URL = 'https://puguoqviaogqcsjrdkbk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1Z3VvcXZpYW9ncWNzanJka2JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjQ4NTgsImV4cCI6MjA4MjcwMDg1OH0.D7W_uNWY1FpjKtPh7CkBOQNEhyQnYIcZIsFa1LhouPw';
        
        // Changed to supabaseClient to avoid conflict with library 'supabase' variable
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // STATE
        let appState = {
            user: null,
            entries: [],
            votes: [],
            users: {}, // Map<uid, userObj>
            loading: false
        };

        // INIT
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // Check Session
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                handleAuthSuccess(session.user);
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
            }

            // Realtime Listeners
            document.getElementById('global-search').addEventListener('input', (e) => renderFeed(e.target.value));
            document.getElementById('voter-search').addEventListener('input', (e) => renderVoterList(e.target.value));
        });

        // --- AUTHENTICATION ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');

            msg.innerText = "Authenticating...";
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                msg.innerText = error.message;
                msg.classList.add('text-red-500');
                return;
            }

            handleAuthSuccess(data.user);
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        function handleAuthSuccess(user) {
            appState.user = user;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('current-user-email').innerText = user.email;
            
            // Load Data
            refreshData();

            // Subscribe to Realtime
            supabaseClient.channel('admin-feed')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'user_votes' }, payload => {
                    handleNewVote(payload.new);
                })
                .subscribe();
        }

        // --- DATA FETCHING ---
        async function refreshData() {
            setLoading(true);
            try {
                // 1. Fetch Entries
                const { data: ent } = await supabaseClient.from('entries').select('*');
                appState.entries = ent || [];

                // 2. Fetch Users (From the new VIEW)
                const { data: usrs, error: userError } = await supabaseClient.from('admin_users_readonly').select('*');
                
                if (usrs) {
                    appState.users = usrs.reduce((acc, u) => {
                        acc[u.uid] = u; // Map by UID
                        return acc;
                    }, {});
                } else {
                    console.warn("Could not fetch user details. Ensure 'admin_users_readonly' view exists.", userError);
                }

                // 3. Fetch Votes
                const { data: vts, error: voteError } = await supabaseClient
                    .from('user_votes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (voteError) throw voteError;

                appState.votes = vts || [];

                updateUI();

            } catch (err) {
                console.error(err);
                if(err.code === '42501' || err.message.includes('policy')) {
                     alert("Access Denied. Ensure you ran the SQL Policy script to allow your email access.");
                }
            }
            setLoading(false);
        }

        function setLoading(bool) {
            const loader = document.getElementById('global-loader');
            const ind = document.getElementById('refresh-indicator');
            if(bool) {
                loader.classList.remove('hidden');
                ind.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
                ind.classList.add('hidden');
            }
        }

        function handleNewVote(newVote) {
            appState.votes.unshift(newVote);
            updateUI();
            
            // Flash notification?
            const row = document.getElementById(`row-${newVote.id}`);
            if(row) {
                row.classList.add('bg-primary/20');
                setTimeout(() => row.classList.remove('bg-primary/20'), 2000);
            }
        }

        // --- RENDERING ---
        function updateUI() {
            updateStats();
            renderFeed();
            renderVoterList();
            renderCandidates();
        }

        function getUserInfo(uid) {
            const u = appState.users[uid];
            if (u) return u;
            // Fallback if user view isn't working or user missing
            return {
                display_name: `User ${uid.substring(0,6)}`,
                email: 'Unknown Email',
                avatar_url: null,
                uid: uid
            };
        }

        function getEntryInfo(eid) {
            return appState.entries.find(e => e.id === eid) || { name: 'Unknown Entity', image_url: '', section: '?' };
        }

        function renderFeed(search = '') {
            const tbody = document.getElementById('feed-table-body');
            tbody.innerHTML = '';

            const term = search.toLowerCase();
            const filtered = appState.votes.filter(v => {
                const u = getUserInfo(v.user_id);
                const e = getEntryInfo(v.entry_id);
                return (
                    v.id.includes(term) ||
                    u.display_name.toLowerCase().includes(term) ||
                    u.email.toLowerCase().includes(term) ||
                    e.name.toLowerCase().includes(term)
                );
            });

            filtered.slice(0, 100).forEach(v => {
                const user = getUserInfo(v.user_id);
                const entry = getEntryInfo(v.entry_id);
                const time = new Date(v.created_at).toLocaleTimeString();
                
                let scoreColor = 'text-gray-400';
                if(v.score < 30) scoreColor = 'text-red-400 font-bold';
                if(v.score > 80) scoreColor = 'text-green-400 font-bold';

                const tr = document.createElement('tr');
                tr.id = `row-${v.id}`;
                tr.className = 'hover:bg-white/5 transition-colors border-b border-border/50 group';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-muted font-mono text-[10px] whitespace-nowrap">${time}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3 cursor-pointer" onclick="openVoter('${v.user_id}')">
                            ${user.avatar_url 
                                ? `<img src="${user.avatar_url}" class="w-6 h-6 rounded-full bg-black object-cover border border-border">` 
                                : `<div class="w-6 h-6 rounded-full bg-surface border border-border flex items-center justify-center text-[10px] text-muted"><i data-lucide="user" class="w-3 h-3"></i></div>`
                            }
                            <div>
                                <div class="font-medium text-gray-200 group-hover:text-primary transition-colors">${user.display_name}</div>
                                <div class="text-[10px] text-muted font-mono hidden group-hover:block">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] bg-white/5 border border-white/10 px-1.5 rounded text-gray-400 font-mono">${entry.section}</span>
                            <span class="text-gray-300 text-xs">${entry.name}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-right ${scoreColor} font-mono text-xs">${v.score}</td>
                    <td class="px-4 py-3">
                        ${v.score < 20 ? '<i data-lucide="thumbs-down" class="w-3 h-3 text-red-500/50"></i>' : ''}
                        ${v.score > 90 ? '<i data-lucide="star" class="w-3 h-3 text-yellow-500/50"></i>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function renderVoterList(filter = '') {
            const container = document.getElementById('voter-list-container');
            container.innerHTML = '';
            
            // Group votes by user
            const stats = {};
            appState.votes.forEach(v => {
                if(!stats[v.user_id]) stats[v.user_id] = { count: 0, sum: 0, last: v.created_at };
                stats[v.user_id].count++;
                stats[v.user_id].sum += v.score;
            });

            // Convert to array and merge with user info
            const list = Object.keys(stats).map(uid => {
                return { ...getUserInfo(uid), ...stats[uid] };
            });

            const term = filter.toLowerCase();
            const filtered = list.filter(u => u.display_name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term));

            filtered.sort((a,b) => b.count - a.count).forEach(u => {
                const el = document.createElement('div');
                el.className = 'p-2 rounded-lg hover:bg-white/5 cursor-pointer flex items-center gap-3 group transition-all border border-transparent hover:border-border';
                el.onclick = () => openVoter(u.uid);
                el.innerHTML = `
                    <div class="relative">
                         ${u.avatar_url 
                            ? `<img src="${u.avatar_url}" class="w-8 h-8 rounded-full bg-black object-cover">`
                            : `<div class="w-8 h-8 rounded-full bg-surface border border-border flex items-center justify-center text-muted"><i data-lucide="user" class="w-4 h-4"></i></div>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold text-gray-300 group-hover:text-white truncate">${u.display_name}</div>
                        <div class="text-[10px] text-muted truncate">${u.email}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-mono font-bold text-primary">${u.count}</div>
                        <div class="text-[9px] text-muted">votes</div>
                    </div>
                `;
                container.appendChild(el);
            });
            lucide.createIcons();
        }

        function openVoter(uid) {
            switchView('voters');
            
            const user = getUserInfo(uid);
            const userVotes = appState.votes.filter(v => v.user_id === uid);
            
            document.getElementById('voter-placeholder').classList.add('hidden');
            document.getElementById('voter-content').classList.remove('hidden');

            document.getElementById('vd-name').innerText = user.display_name;
            document.getElementById('vd-email').innerText = user.email;
            document.getElementById('vd-id').innerText = uid;
            document.getElementById('vd-avatar').src = user.avatar_url || 'https://via.placeholder.com/100/000000/FFFFFF/?text=User';
            document.getElementById('vd-joined').innerText = user.created_at ? new Date(user.created_at).toLocaleDateString() : '--';

            document.getElementById('vd-count').innerText = userVotes.length;
            const avg = userVotes.length ? (userVotes.reduce((a,b)=>a+b.score,0)/userVotes.length).toFixed(1) : 0;
            document.getElementById('vd-avg').innerText = avg;

            const history = document.getElementById('vd-history');
            history.innerHTML = '';

            userVotes.forEach(v => {
                const entry = getEntryInfo(v.entry_id);
                const el = document.createElement('div');
                
                let barColor = 'bg-gray-700';
                if(v.score > 80) barColor = 'bg-green-500';
                if(v.score < 30) barColor = 'bg-red-500';

                el.className = 'p-2 rounded bg-surface border border-border flex items-center gap-3';
                el.innerHTML = `
                    <img src="${entry.image_url}" class="w-8 h-8 rounded object-cover bg-black">
                    <div class="flex-1">
                        <div class="text-xs font-bold text-gray-300">${entry.name}</div>
                        <div class="text-[10px] text-muted">${new Date(v.created_at).toLocaleString()}</div>
                    </div>
                    <div class="w-24 flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-black rounded-full overflow-hidden">
                            <div class="h-full ${barColor}" style="width: ${v.score}%"></div>
                        </div>
                        <span class="text-xs font-mono w-6 text-right">${v.score}</span>
                    </div>
                `;
                history.appendChild(el);
            });
        }

        function renderCandidates() {
            const grid = document.getElementById('candidates-grid');
            grid.innerHTML = '';
            
            // Calculate stats
            const stats = appState.entries.map(e => {
                const votes = appState.votes.filter(v => v.entry_id === e.id);
                const count = votes.length;
                const avg = count ? (votes.reduce((a,b)=>a+b.score,0)/count).toFixed(1) : 0;
                return { ...e, count, avg };
            }).sort((a,b) => b.count - a.count);

            stats.forEach(e => {
                const el = document.createElement('div');
                el.className = 'glass-panel rounded-xl overflow-hidden group hover:border-primary/50 transition-colors cursor-pointer';
                el.innerHTML = `
                    <div class="h-24 overflow-hidden relative">
                        <img src="${e.image_url}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                        <div class="absolute bottom-0 left-0 w-full p-2 bg-gradient-to-t from-black to-transparent">
                            <div class="text-xs font-bold text-white">${e.name}</div>
                        </div>
                        <div class="absolute top-2 right-2 bg-black/50 backdrop-blur px-2 py-0.5 rounded text-[10px] font-mono border border-white/10">${e.section}</div>
                    </div>
                    <div class="p-3 flex justify-between items-end">
                        <div>
                            <div class="text-[10px] text-muted uppercase">Votes</div>
                            <div class="text-lg font-bold text-white font-mono">${e.count}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-muted uppercase">Avg</div>
                            <div class="text-lg font-bold text-primary font-mono">${e.avg}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        function updateStats() {
            document.getElementById('stat-votes').innerText = appState.votes.length.toLocaleString();
            const uniq = new Set(appState.votes.map(v=>v.user_id)).size;
            document.getElementById('stat-voters').innerText = uniq.toLocaleString();
            
            const total = appState.votes.reduce((a,b)=>a+b.score,0);
            const avg = appState.votes.length ? (total/appState.votes.length).toFixed(1) : 0;
            document.getElementById('stat-avg').innerText = avg;
            
            if(appState.votes.length) {
                const last = new Date(appState.votes[0].created_at);
                const diff = Math.floor((new Date() - last) / 60000); // mins
                document.getElementById('stat-last').innerText = diff < 1 ? 'Just now' : `${diff}m ago`;
            }
        }

        // --- UTILS ---
        function switchView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Nav Highlighting
            const navIds = ['nav-feed', 'nav-voters', 'nav-candidates'];
            navIds.forEach(id => {
                const el = document.getElementById(id);
                if(id === `nav-${viewName}`) {
                    el.classList.remove('text-muted', 'hover:bg-white/5');
                    el.classList.add('bg-white/5', 'text-white', 'border-white/5');
                    el.querySelector('i').classList.add('text-primary');
                } else {
                    el.classList.add('text-muted', 'hover:bg-white/5');
                    el.classList.remove('bg-white/5', 'text-white', 'border-white/5');
                    el.querySelector('i').classList.remove('text-primary');
                }
            });
        }

        function exportCSV() {
            let csv = "ID,Timestamp,UserID,UserName,UserEmail,EntityID,EntityName,Score\n";
            appState.votes.forEach(v => {
                const u = getUserInfo(v.user_id);
                const e = getEntryInfo(v.entry_id);
                csv += `${v.id},${v.created_at},${v.user_id},"${u.display_name}","${u.email}",${v.entry_id},"${e.name}",${v.score}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexus_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>