<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS | Prime Database</title>
    
    <!-- FONTS -->
    <link href="https://api.fontshare.com/v2/css?f[]=clash-display@400,500,600,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- CONFIG -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#020202',
                        panel: '#0C0C0C',
                        surface: '#151515',
                        'accent-a': '#3B82F6', 
                        'accent-b': '#EAB308', 
                        'accent-h': '#10B981', 
                        gold: '#FFD700',
                        silver: '#E0E0E0',
                        bronze: '#CD7F32',
                    },
                    fontFamily: {
                        display: ['Clash Display', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        body: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 12s linear infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --ease-out-expo: cubic-bezier(0.19, 1, 0.22, 1);
        }

        body {
            background-color: #020202;
            color: #e2e2e2;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- STARRY BACKGROUND --- */
        #starfield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }

        /* --- UI ELEMENTS --- */
        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-btn.active {
            background: #fff; color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.4);
        }

        /* --- APEX CARD (Rank 1) --- */
        .apex-card {
            position: relative; overflow: hidden;
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            transition: transform 0.6s var(--ease-out-expo);
        }
        .apex-card::before {
            content: ''; position: absolute; inset: 0; z-index: 10;
            background: linear-gradient(180deg, rgba(255,215,0,0.05) 0%, transparent 40%);
            pointer-events: none;
        }
        .apex-card:hover { transform: scale-[1.01]}

        /* Holographic Border Effect */
        .holo-border {
            position: absolute; inset: 0; pointer-events: none; z-index: 20;
            border: 1px solid transparent;
            mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
        }
        .holo-border::after {
            content: ""; position: absolute; inset: -1px;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.4), transparent);
            animation: spin-slow 4s linear infinite;
        }

        /* --- DATA ROWS --- */
        .data-row {
            display: grid; grid-template-columns: 60px 80px 1fr 100px 100px;
            align-items: center; padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .data-row::before {
            content: ''; position: absolute; left: 0; top: 0; width: 2px; height: 100%;
            background: #fff; transform: scaleY(0); transition: transform 0.3s ease;
        }
        .data-row:hover {
            background: rgba(255,255,255,0.03); padding-left: 24px;
        }
        .data-row:hover::before { transform: scaleY(1); }
        
        .vote-btn-slide {
            transform: translateX(20px); opacity: 0; transition: all 0.3s ease;
        }
        .data-row:hover .vote-btn-slide {
            transform: translateX(0); opacity: 1;
        }

        @media (max-width: 768px) {
            .data-row {
                grid-template-columns: 40px 1fr 60px; grid-template-rows: auto auto; gap: 8px;
            }
            .vote-btn-slide { transform: none; opacity: 1; }
            .data-row-img { grid-row: span 2; }
            .data-row-meta { grid-column: 2; }
            .data-row-score { grid-column: 3; grid-row: 1; text-align: right; }
            .data-row-action { grid-column: 3; grid-row: 2; justify-self: end; }
        }

        /* --- AUTH MODAL TABS --- */
        .auth-tab {
            padding: 10px; flex: 1; text-align: center;
            font-family: 'JetBrains Mono', monospace; font-size: 10px;
            text-transform: uppercase; letter-spacing: 2px;
            cursor: pointer; border-bottom: 2px solid transparent; opacity: 0.5;
            transition: all 0.3s ease;
        }
        .auth-tab.active {
            border-bottom-color: #fff; opacity: 1;
        }

        /* --- TICKER --- */
        .ticker-wrap {
            position: fixed; top: 64px; width: 100%; overflow: hidden; height: 24px;
            background: rgba(0,0,0,0.8); border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 40; pointer-events: none; display: flex; align-items: center;
        }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 30s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; font-family: 'JetBrains Mono'; font-size: 9px; color: rgba(255,255,255,0.4); }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- ANIMATIONS --- */
        .entry-item { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s var(--ease-out-expo) forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="selection:bg-white selection:text-black">

    <canvas id="starfield"></canvas>
    <div class="fixed inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none z-0 mix-blend-overlay"></div>

    <!-- NAV -->
    <nav class="fixed top-0 w-full z-50 glass-panel h-16 flex items-center justify-between px-6 lg:px-12">
        <div class="flex items-center gap-3 group cursor-pointer" onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <div class="w-8 h-8 bg-white flex items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-black translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                <div class="relative z-10 w-2 h-2 bg-black rounded-full group-hover:bg-white transition-colors"></div>
            </div>
            <div class="flex flex-col">
                <span class="font-display font-bold text-lg tracking-widest leading-none">NEXUS</span>
                <span class="text-[8px] font-mono text-white/40 tracking-[0.3em] uppercase">Prime DB</span>
            </div>
        </div>

        <div class="hidden md:flex gap-1 bg-white/5 p-1 rounded-full border border-white/5 backdrop-blur-md">
            <button onclick="filterBy('all')" class="nav-btn active px-6 py-1.5 rounded-full text-[10px] font-bold font-mono uppercase transition-all">All</button>
            <button onclick="filterBy('Section A')" class="nav-btn px-6 py-1.5 rounded-full text-[10px] font-bold font-mono uppercase text-white/50 hover:text-white transition-all">Sec A</button>
            <button onclick="filterBy('Section B')" class="nav-btn px-6 py-1.5 rounded-full text-[10px] font-bold font-mono uppercase text-white/50 hover:text-white transition-all">Sec B</button>
            <button onclick="filterBy('Section H')" class="nav-btn px-6 py-1.5 rounded-full text-[10px] font-bold font-mono uppercase text-white/50 hover:text-white transition-all">Sec H</button>
        </div>

        <div id="auth-ui">
            <!-- Injected -->
        </div>
    </nav>

    <!-- TICKER -->
    <div class="ticker-wrap hidden md:flex">
        <div class="ticker">
            <span class="ticker-item">SYSTEM STATUS: ONLINE</span>
            <span class="ticker-item">BATCH 26 INTEGRITY: 100%</span>
            <span class="ticker-item">LIVE DATA FEED ACTIVE</span>
            <span class="ticker-item">ENCRYPTED CONNECTION ESTABLISHED</span>
            <span class="ticker-item">VOTING PROTOCOLS ENABLED</span>
            <span class="ticker-item">SYSTEM STATUS: ONLINE</span>
            <span class="ticker-item">BATCH 26 INTEGRITY: 100%</span>
        </div>
    </div>

    <!-- MAIN -->
    <main class="relative z-10 pt-32 pb-20 px-4 md:px-8 lg:px-16 max-w-7xl mx-auto">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-end mb-16 border-b border-white/10 pb-8 gap-6">
            <div class="relative">
                <div class="absolute -left-6 top-0 h-full w-1 bg-accent-a/50"></div>
                <p class="font-mono text-[10px] text-accent-a mb-2 uppercase tracking-[0.3em]">Global Aggregation</p>
                <h1 class="font-display text-5xl md:text-7xl text-white uppercase leading-[0.9] tracking-tight">Prime<br><span class="text-white/10">Database</span></h1>
            </div>
            <div class="flex gap-10 font-mono text-xs text-right">
                <div class="hidden md:block">
                    <span class="block text-white/30 uppercase tracking-widest mb-1 text-[9px]">Server Time</span>
                    <span id="clock" class="text-white">00:00:00</span>
                </div>
                <div>
                    <span class="block text-white/30 uppercase tracking-widest mb-1 text-[9px]">Entities</span>
                    <span class="text-white text-xl" id="stat-count">--</span>
                </div>
                <div>
                    <span class="block text-white/30 uppercase tracking-widest mb-1 text-[9px]">Votes</span>
                    <span class="text-white text-xl" id="stat-votes">--</span>
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <div id="content-area" class="min-h-[600px]">
            <div class="space-y-4 animate-pulse opacity-30">
                <div class="h-[500px] bg-white/5 w-full rounded-2xl border border-white/5"></div>
            </div>
        </div>

    </main>

    <!-- MOBILE FILTER -->
    <div class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-white/10 backdrop-blur-xl border border-white/10 p-1.5 rounded-full flex gap-2 shadow-[0_10px_30px_rgba(0,0,0,0.5)]">
        <button onclick="filterBy('all')" class="w-10 h-10 rounded-full bg-white text-black flex items-center justify-center font-bold text-[10px] shadow-lg">ALL</button>
        <button onclick="filterBy('Section A')" class="w-10 h-10 rounded-full bg-black/40 text-accent-a border border-white/10 flex items-center justify-center font-bold text-[10px]">A</button>
        <button onclick="filterBy('Section B')" class="w-10 h-10 rounded-full bg-black/40 text-accent-b border border-white/10 flex items-center justify-center font-bold text-[10px]">B</button>
        <button onclick="filterBy('Section H')" class="w-10 h-10 rounded-full bg-black/40 text-accent-h border border-white/10 flex items-center justify-center font-bold text-[10px]">H</button>
    </div>

    <!-- AUTH MODAL (DUAL MODE) -->
    <div id="auth-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md transition-opacity duration-300" onclick="toggleAuthModal()"></div>
        
        <div class="relative z-10 w-full max-w-md bg-[#0a0a0a] border border-white/10 shadow-2xl overflow-hidden group">
            <!-- Animated Border -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-50"></div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-white/5">
                <div onclick="switchAuthMode('login')" id="tab-login" class="auth-tab active">Login Access</div>
                <div onclick="switchAuthMode('register')" id="tab-register" class="auth-tab">New Registration</div>
            </div>

            <div class="p-8">
                <div class="mb-8 text-center">
                    <div class="w-12 h-12 bg-white text-black mx-auto flex items-center justify-center mb-4">
                        <i data-lucide="fingerprint" class="w-6 h-6"></i>
                    </div>
                    <h2 class="font-display text-2xl text-white uppercase tracking-widest">Identify</h2>
                    <p class="text-[10px] font-mono text-white/40 uppercase mt-2 tracking-widest">Secure Gateway</p>
                </div>

                <!-- LOGIN FORM -->
                <form id="login-form" class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Email Address</label>
                        <input type="email" id="login-email" required class="w-full bg-black border border-white/10 p-3 text-sm text-white focus:border-white transition-colors outline-none font-mono">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Password</label>
                        <input type="password" id="login-password" required class="w-full bg-black border border-white/10 p-3 text-sm text-white focus:border-white transition-colors outline-none font-mono">
                    </div>
                    <button type="submit" class="w-full py-4 bg-white text-black font-mono uppercase text-xs font-bold tracking-widest hover:bg-gray-200 mt-4">Authenticate</button>
                </form>

                <!-- REGISTER FORM -->
                <form id="register-form" class="space-y-3 hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Full Name</label>
                            <input type="text" id="reg-name" required placeholder="John Doe" class="w-full bg-black border border-white/10 p-3 text-xs text-white focus:border-white outline-none font-mono">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Username</label>
                            <input type="text" id="reg-username" required placeholder="@handle" class="w-full bg-black border border-white/10 p-3 text-xs text-white focus:border-white outline-none font-mono">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Email</label>
                        <input type="email" id="reg-email" required class="w-full bg-black border border-white/10 p-3 text-xs text-white focus:border-white outline-none font-mono">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[9px] font-mono text-white/30 uppercase tracking-widest">Password</label>
                        <input type="password" id="reg-password" required class="w-full bg-black border border-white/10 p-3 text-xs text-white focus:border-white outline-none font-mono">
                    </div>
                    <button type="submit" class="w-full py-4 bg-white/10 text-white border border-white/20 font-mono uppercase text-xs font-bold tracking-widest hover:bg-white hover:text-black transition-all mt-4">Create Identity</button>
                </form>

                <p id="auth-msg" class="text-center text-[10px] text-accent-b mt-4 h-4 font-mono uppercase tracking-wide"></p>
            </div>
        </div>
    </div>

    <!-- VOTE SLIDER MODAL -->
    <div id="vote-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-xl transition-opacity duration-300 opacity-0" id="vote-backdrop" onclick="closeVoteModal()"></div>
        
        <div class="absolute right-0 top-0 h-full w-full md:w-[500px] bg-[#0C0C0C] border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] flex flex-col" id="vote-panel">
            <button onclick="closeVoteModal()" class="absolute top-6 right-6 text-white/30 hover:text-white transition-colors z-50">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>

            <div class="h-[40%] relative bg-black">
                <div id="vote-img-bg" class="absolute inset-0 bg-cover bg-center opacity-60"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-[#0C0C0C] via-[#0C0C0C]/50 to-transparent"></div>
                <div class="absolute bottom-8 left-8 right-8">
                    <span id="vote-sec-tag" class="text-[9px] font-mono border px-2 py-1 uppercase tracking-widest mb-3 inline-block bg-black/50 backdrop-blur">Section A</span>
                    <h2 id="vote-name" class="font-display text-4xl text-white mb-1 leading-none">Entity Name</h2>
                    <p id="vote-theme" class="font-serif italic text-white/50 text-sm">Theme Description</p>
                </div>
            </div>

            <div class="flex-1 p-8 flex flex-col justify-center relative overflow-hidden">
                <div id="glow-bg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-blue-500/20 blur-[100px] rounded-full pointer-events-none transition-colors duration-500"></div>

                <div class="relative z-10 space-y-10">
                    <div class="text-center">
                        <span id="score-val" class="font-display text-8xl text-white block mb-2 tabular-nums">50</span>
                        <span id="score-text" class="font-mono text-xs uppercase tracking-[0.4em] text-accent-a">Standard</span>
                    </div>

                    <div class="relative h-1 bg-white/10 w-full">
                        <div id="slider-track" class="absolute left-0 top-0 h-full bg-white w-1/2 transition-all duration-75"></div>
                        <input type="range" id="vote-slider" min="1" max="100" value="50" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                        <div id="slider-thumb" class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rotate-45 pointer-events-none transition-all duration-75 shadow-[0_0_20px_white]" style="left: 50%"></div>
                    </div>

                    <button onclick="submitVote()" id="submit-btn" class="w-full py-5 bg-white hover:bg-white/90 text-black font-bold font-mono uppercase tracking-widest transition-all clip-path-slant relative overflow-hidden group">
                        <span class="relative z-10">Confirm Evaluation</span>
                        <div class="absolute inset-0 bg-gray-200 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300 z-0"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">Action Completed</div>

    <!-- LOGIC -->
    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://puguoqviaogqcsjrdkbk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1Z3VvcXZpYW9ncWNzanJka2JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjQ4NTgsImV4cCI6MjA4MjcwMDg1OH0.D7W_uNWY1FpjKtPh7CkBOQNEhyQnYIcZIsFa1LhouPw';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let entries = [];
        let userVotes = {};
        let currentUser = null;
        let activeEntryId = null;

        // --- STARFIELD FX ---
        class StarfieldCanvas {
            constructor() {
                this.canvas = document.getElementById('starfield');
                this.ctx = this.canvas.getContext('2d');
                this.stars = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate();
            }
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.initStars();
            }
            initStars() {
                this.stars = [];
                for(let i=0; i<150; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        z: Math.random() * 2,
                        o: Math.random()
                    });
                }
            }
            animate() {
                this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
                const scrollY = window.scrollY;
                this.stars.forEach(s => {
                    let yPos = (s.y - scrollY * s.z * 0.2) % this.canvas.height;
                    if(yPos < 0) yPos += this.canvas.height;
                    
                    this.ctx.fillStyle = `rgba(255,255,255,${s.o * 0.5})`;
                    this.ctx.beginPath();
                    this.ctx.arc(s.x, yPos, s.z * 0.8, 0, Math.PI*2);
                    this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            new StarfieldCanvas();
            init();
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-US', {hour12:false});
            }, 1000);
        });

        async function init() {
            await checkUser();
            await fetchEntries();
            if(currentUser) await fetchUserVotes();
            renderView(entries);
            setupRealtime();
        }

        // --- RENDERER ---
        function renderView(data) {
            const container = document.getElementById('content-area');
            container.innerHTML = ''; 

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-32 font-mono text-white/30 text-xs border border-white/10 rounded-lg border-dashed">NO SIGNALS DETECTED</div>`;
                return;
            }

            // Stats
            document.getElementById('stat-count').innerText = data.length;
            document.getElementById('stat-votes').innerText = data.reduce((a,b) => a + (b.votes || 0), 0);

            const apex = data[0];
            const elite = data.slice(1, 3);
            const stream = data.slice(3);

            // APEX
            if (apex) container.insertAdjacentHTML('beforeend', createApexCard(apex));

            // ELITE
            if (elite.length > 0) {
                const eliteWrapper = document.createElement('div');
                eliteWrapper.className = "grid grid-cols-1 md:grid-cols-2 gap-6 mt-6";
                elite.forEach((e, i) => eliteWrapper.innerHTML += createEliteCard(e, i + 2));
                container.appendChild(eliteWrapper);
            }

            // STREAM
            if (stream.length > 0) {
                container.insertAdjacentHTML('beforeend', `<div class="mt-16 mb-6 font-mono text-[9px] uppercase tracking-widest text-white/30 flex items-center gap-4"><div class="h-px bg-white/10 flex-1"></div>Global Data Stream<div class="h-px bg-white/10 flex-1"></div></div>`);
                const streamWrapper = document.createElement('div');
                streamWrapper.className = "flex flex-col border-t border-white/5";
                stream.forEach((e, i) => streamWrapper.innerHTML += createStreamRow(e, i + 4));
                container.appendChild(streamWrapper);
            }

            lucide.createIcons();
        }

        // --- COMPONENTS ---
        function createApexCard(e) {
            const score = parseFloat(e.score).toFixed(1);
            const hasVoted = userVotes[e.id] !== undefined;
            return `
            <div class="apex-card relative w-full h-[550px] md:h-[650px] rounded-lg group entry-item bg-[#050505]" style="animation-delay: 0ms">
                <div class="holo-border"></div>
                
                <div class="absolute inset-0 z-0">
                    <img src="${e.image_url}" class="w-full h-full object-cover transition-transform duration-[2s] group-hover:scale-105" alt="${e.name}">
                    <div class="absolute inset-0 bg-gradient-to-t from-void via-void/40 to-transparent"></div>
                </div>
                
                <div class="absolute top-8 left-8 z-20 flex flex-col gap-2">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gold text-black font-display font-bold text-2xl flex items-center justify-center shadow-[0_0_30px_#FFD700]">#1</div>
                        <div class="bg-black/60 backdrop-blur border border-gold/30 px-3 py-1 text-[9px] font-mono uppercase tracking-widest text-gold">Current Apex</div>
                    </div>
                </div>

                <div class="absolute bottom-0 left-0 w-full p-8 md:p-12 z-20 flex flex-col md:flex-row justify-between items-end gap-8">
                    <div class="flex-1">
                        <span class="text-[10px] font-bold bg-white/10 backdrop-blur border border-white/10 text-white px-2 py-1 uppercase tracking-widest mb-4 inline-block">${e.section}</span>
                        <h2 class="font-display text-5xl md:text-8xl text-white leading-none mb-2 drop-shadow-2xl">${e.name}</h2>
                        <p class="font-serif italic text-white/70 text-lg border-l-2 border-gold pl-4">${e.theme || 'Unknown Theme'}</p>
                    </div>

                    <div class="flex items-center gap-8">
                        <div class="text-right hidden md:block">
                            <span class="block text-gold font-display text-7xl leading-none tracking-tighter">${score}</span>
                            <span class="text-[9px] font-mono text-white/40 uppercase tracking-[0.2em]">Score Index</span>
                        </div>
                        <button onclick="openVoteModal('${e.id}', '${e.section}')" class="w-20 h-20 rounded-full border border-white/20 bg-white/5 backdrop-blur hover:bg-white hover:text-black transition-all flex items-center justify-center group/btn ${hasVoted ? 'bg-white text-black' : ''}">
                            <i data-lucide="${hasVoted ? 'check' : 'arrow-up-right'}" class="w-8 h-8 transition-transform group-hover/btn:rotate-45"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function createEliteCard(e, rank) {
            const score = parseFloat(e.score).toFixed(1);
            const color = rank === 2 ? 'silver' : 'bronze';
            const hasVoted = userVotes[e.id] !== undefined;
            return `
            <div class="relative h-[450px] rounded border border-white/10 overflow-hidden group entry-item bg-[#080808]" style="animation-delay: ${rank * 100}ms">
                <img src="${e.image_url}" class="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-all duration-700 scale-100 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                
                <div class="absolute top-4 left-4 w-10 h-10 bg-${color} text-black font-display font-bold text-xl flex items-center justify-center shadow-lg">#${rank}</div>
                
                <div class="absolute bottom-6 left-6 right-6">
                    <h3 class="font-display text-3xl text-white mb-2 leading-none">${e.name}</h3>
                    <div class="flex justify-between items-end border-t border-white/20 pt-4">
                        <span class="font-mono text-2xl text-${color}">${score}</span>
                        <button onclick="openVoteModal('${e.id}', '${e.section}')" class="text-[10px] font-bold uppercase tracking-widest hover:text-${color} transition-colors ${hasVoted ? 'text-green-500' : 'text-white/50'}">
                            ${hasVoted ? 'Evaluated' : 'Access Vote ->'}
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function createStreamRow(e, rank) {
            const score = parseFloat(e.score).toFixed(1);
            const hasVoted = userVotes[e.id] !== undefined;
            return `
            <div class="data-row group entry-item cursor-pointer" onclick="openVoteModal('${e.id}', '${e.section}')" style="animation-delay: ${(rank-2) * 50}ms">
                <div class="font-mono text-white/20 text-xs">#${rank < 10 ? '0'+rank : rank}</div>
                
                <div class="data-row-img w-12 h-12 bg-white/5 overflow-hidden border border-white/5 relative grayscale group-hover:grayscale-0 transition-all">
                    <img src="${e.image_url}" class="w-full h-full object-cover">
                </div>
                
                <div class="data-row-meta pl-4">
                    <h4 class="font-display text-lg text-white group-hover:text-accent-a transition-colors truncate">${e.name}</h4>
                    <p class="text-[9px] text-white/30 font-mono uppercase tracking-widest hidden md:block">${e.theme || 'Restricted'}</p>
                </div>

                <div class="data-row-score font-mono text-white font-bold text-right pr-4 text-sm">${score}</div>
                
                <div class="data-row-action text-right">
                    <div class="vote-btn-slide">
                        <span class="w-8 h-8 inline-flex items-center justify-center border border-white/20 rounded-full hover:bg-white hover:text-black transition-all ${hasVoted ? 'bg-white/10 border-transparent text-white/30' : ''}">
                             <i data-lucide="${hasVoted ? 'check' : 'plus'}" class="w-4 h-4"></i>
                        </span>
                    </div>
                </div>
            </div>`;
        }

        // --- AUTH & USER ---
        function switchAuthMode(mode) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabReg = document.getElementById('tab-register');
            const msg = document.getElementById('auth-msg');
            msg.innerText = '';

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                tabLogin.classList.add('active');
                tabReg.classList.remove('active');
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                tabLogin.classList.remove('active');
                tabReg.classList.add('active');
            }
        }

        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user;
            updateAuthUI();
        }

        function updateAuthUI() {
            const ui = document.getElementById('auth-ui');
            if (currentUser) {
                const meta = currentUser.user_metadata || {};
                const handle = meta.username ? `@${meta.username}` : 'UNK_USER';
                
                ui.innerHTML = `
                <div class="flex items-center gap-4 bg-white/5 pl-4 pr-1 py-1 rounded-full border border-white/5">
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] font-bold text-white uppercase leading-none">${meta.name || 'Agent'}</span>
                        <span class="text-[8px] font-mono text-white/40">${handle}</span>
                    </div>
                    <button onclick="logout()" class="w-8 h-8 rounded-full bg-red-500/10 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                        <i data-lucide="power" class="w-3 h-3"></i>
                    </button>
                </div>`;
            } else {
                ui.innerHTML = `
                <button onclick="toggleAuthModal()" class="flex items-center gap-2 text-[10px] font-bold uppercase border border-white/20 px-4 py-2 rounded-full hover:bg-white hover:text-black transition-all group">
                    <span>Connect ID</span>
                    <i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-1 transition-transform"></i>
                </button>`;
            }
            lucide.createIcons();
        }

        function toggleAuthModal() {
            const m = document.getElementById('auth-modal');
            m.classList.toggle('hidden');
            switchAuthMode('login'); // Reset to login by default
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        // --- AUTH HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('auth-msg');

            msg.innerText = "AUTHENTICATING...";
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            
            if (error) {
                msg.innerText = "ACCESS DENIED: " + error.message;
                msg.classList.add('text-red-500');
            } else {
                msg.innerText = "ACCESS GRANTED";
                msg.classList.remove('text-red-500');
                msg.classList.add('text-green-500');
                setTimeout(() => window.location.reload(), 800);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const username = document.getElementById('reg-username').value;
            const msg = document.getElementById('auth-msg');

            if (!name || !username) {
                msg.innerText = "ALL FIELDS REQUIRED";
                return;
            }

            msg.innerText = "CREATING IDENTITY...";
            // SignUp with Meta Data
            const { data, error } = await supabaseClient.auth.signUp({ 
                email, 
                password,
                options: {
                    data: {
                        name: name,
                        username: username.replace('@','') // Clean handle
                    }
                }
            });

            if (error) {
                msg.innerText = "ERROR: " + error.message;
            } else if (data.user && !data.session) {
                msg.innerText = "VERIFICATION EMAIL SENT";
            } else {
                msg.innerText = "IDENTITY ESTABLISHED";
                setTimeout(() => window.location.reload(), 800);
            }
        });

        // --- VOTE & FILTER LOGIC (Existing) ---
        function filterBy(sec) {
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active', 'text-black', 'bg-white');
                b.classList.add('text-white/50');
            });
            event.target.classList.add('active', 'text-black', 'bg-white');
            event.target.classList.remove('text-white/50');
            if (sec === 'all') renderView(entries);
            else renderView(entries.filter(e => e.section === sec));
        }

        function openVoteModal(id, section) {
            if(!currentUser) { toggleAuthModal(); return; }
            activeEntryId = id;
            const entry = entries.find(e => e.id === id);
            document.getElementById('vote-name').innerText = entry.name;
            document.getElementById('vote-theme').innerText = entry.theme || 'Unknown';
            document.getElementById('vote-img-bg').style.backgroundImage = `url('${entry.image_url}')`;
            
            const tag = document.getElementById('vote-sec-tag');
            tag.innerText = section;
            let color = '#3B82F6';
            if (section === 'Section B') color = '#EAB308';
            if (section === 'Section H') color = '#10B981';
            tag.style.color = color; tag.style.borderColor = color;
            document.getElementById('glow-bg').style.backgroundColor = color + '40';

            const modal = document.getElementById('vote-modal');
            const panel = document.getElementById('vote-panel');
            const backdrop = document.getElementById('vote-backdrop');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('translate-x-full');
            }, 10);
        }

        function closeVoteModal() {
            const modal = document.getElementById('vote-modal');
            const panel = document.getElementById('vote-panel');
            const backdrop = document.getElementById('vote-backdrop');
            panel.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        const slider = document.getElementById('vote-slider');
        slider.addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('score-val').innerText = val;
            document.getElementById('slider-thumb').style.left = `${val}%`;
            document.getElementById('slider-track').style.width = `${val}%`;
            
            let text = "Standard"; let color = "text-white";
            if(val > 40) { text = "Commendable"; color = "text-accent-a"; }
            if(val > 70) { text = "Exceptional"; color = "text-accent-b"; }
            if(val > 90) { text = "World Class"; color = "text-gold"; }
            
            const txtEl = document.getElementById('score-text');
            txtEl.innerText = text;
            txtEl.className = `font-mono text-xs uppercase tracking-[0.4em] ${color}`;
        });

        async function submitVote() {
            const score = parseInt(slider.value);
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = `<span class="animate-pulse">Transmitting...</span>`;
            
            const { error } = await supabaseClient.from('user_votes').insert({ user_id: currentUser.id, entry_id: activeEntryId, score });
            
            if(error) {
                showToast(error.message);
                btn.innerText = "Error";
            } else {
                userVotes[activeEntryId] = score;
                if(score > 85) confetti({ particleCount: 150, spread: 80, origin: { x: 1 } });
                showToast("Evaluation Logged");
                closeVoteModal();
                btn.innerHTML = `<span class="relative z-10">Confirm Evaluation</span><div class="absolute inset-0 bg-gray-200 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300 z-0"></div>`;
                document.querySelectorAll(`[onclick="openVoteModal('${activeEntryId}', '${entries.find(e=>e.id===activeEntryId).section}')"]`).forEach(b => {
                    // Update checkmark visual
                });
                renderView(entries); // Refresh view
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        // --- DATA FETCHING ---
        function fetchEntries() {
            return supabaseClient.from('entries').select(`*, ranking_stats ( average_score, count )`).then(({ data }) => {
                if(data) {
                    entries = data.map(e => ({
                        ...e,
                        score: e.ranking_stats?.[0]?.average_score || 0,
                        votes: e.ranking_stats?.[0]?.count || 0
                    })).sort((a,b) => b.score - a.score);
                }
            });
        }
        function fetchUserVotes() {
            return supabaseClient.from('user_votes').select('entry_id, score').eq('user_id', currentUser.id).then(({ data }) => {
                if(data) data.forEach(v => userVotes[v.entry_id] = v.score);
            });
        }
        function setupRealtime() {
            supabaseClient.channel('public:ranking_stats')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'ranking_stats' }, () => {
                    fetchEntries().then(() => renderView(entries));
                }).subscribe();
        }
    </script>
</body>
</html>